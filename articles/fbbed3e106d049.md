---
title: "ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•"
emoji: "ğŸ§µ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["java", "concurrency", "thread"]
published: true
---

# ã¯ã˜ã‚ã«

æœ€åˆã«ã€æœ¬è¨˜äº‹ã¯ã€[Java Concurrency in Practice](https://github.com/AngelSanchezT/books-1/blob/master/concurrency/Java%20Concurrency%20in%20Practice.pdf) ã‚’ä¸»ãªã‚½ãƒ¼ã‚¹ã¨ã—ã¦åŸ·ç­†ã—ã¾ã—ãŸã€‚
ï¼ˆã“ã®å¾Œã«ç™»å ´ã™ã‚‹ä¾‹ã®ã†ã¡ã„ãã¤ã‹ã¯æœ¬æ›¸ã‹ã‚‰å¼•ç”¨ã—ã¦ã„ã¾ã™ï¼‰

ã“ã‚Œã¾ã§ä¸¦è¡Œå‡¦ç†ã‚’ç”¨ã„ãŸå®Ÿè£…ã‚’è¡Œã£ãŸã‚Šã€ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚€æ©Ÿä¼šã¯ã‚ã‚Šã¾ã—ãŸãŒã€ä½“ç³»çš„ã«ç†è§£ã§ãã¦ã„ã‚‹ã‹æ€ªã—ã„çŠ¶æ…‹ã§ã‚ã£ãŸãŸã‚ã€å­¦ã‚“ã ã“ã¨ã‚„èª¿æŸ»ã—ãŸã“ã¨ã‚’è¨˜äº‹ã«ã—ã¾ã—ãŸã€‚

ç§ã¨åŒã˜ã‚ˆã†ã«ã€

- ä¸¦è¡Œãƒ»ä¸¦åˆ—å‡¦ç†ã‚’åˆ©ç”¨ã™ã‚‹æ©Ÿä¼šã¯ã‚ã‚‹ãŒã€ãªã‚“ã¨ãªãåˆ©ç”¨ã—ã¦ã„ã‚‹
- ä½“ç³»çš„ã«å­¦ã‚“ã§ã¿ãŸã„

ã¨ã„ã†æ–¹ã«èª­ã‚“ã§ã„ãŸã ã‘ã‚Œã°ã¨æ€ã„ã¾ã™ã€‚

# ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ã¨ã¯

ã¾ãšã€ã©ã®ã‚ˆã†ãªå ´é¢ã§ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ã‚’æ„è­˜ã™ã‚‹å¿…è¦ãŒç”Ÿã˜ã‚‹ã®ã‹ã€è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

åˆ†ã‹ã‚Šåˆ‡ã£ãŸã“ã¨ã§ã™ãŒã€ã‚·ãƒ³ã‚°ãƒ«ã‚¹ãƒ¬ãƒƒãƒ‰ã§ã‚ã‚Œã°ã€ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ã‚’æ„è­˜ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
ãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰ã§å‡¦ç†ãŒè¡Œã‚ã‚Œã‚‹å ´åˆã®ã¿ã€ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ã‚’æ„è­˜ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ãã®ã†ãˆã§ã€ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ãªã‚³ãƒ¼ãƒ‰ã¨ã¯ã€

- ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹ã§ã‚ã‚‹
- å…±æœ‰ã•ã‚Œã‚‹çŠ¶æ…‹ã€ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ï¼ˆå¯å¤‰ï¼‰ãªçŠ¶æ…‹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’é©åˆ‡ã«ç®¡ç†ã§ãã¦ã„ã‚‹
- è¤‡æ•°ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‹ã‚‰ã©ã®ã‚ˆã†ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã¦ã‚‚æ­£ã—ã„æŒ™å‹•ã‚’è¡Œã†ã“ã¨ãŒã§ãã‚‹

ã‚’æº€ãŸã™ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã¨ãªã‚Šã¾ã™ã€‚

ã¤ã¾ã‚Šã€è¤‡æ•°ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã‚’å—ã‘ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒçŠ¶æ…‹ã‚’ä¿æŒã—ã¦ã„ãªã„å ´åˆã‚„ã€ä¿æŒã—ã¦ã„ã¦ã‚‚ãã‚ŒãŒã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ï¼ˆä¸å¤‰ï¼‰ã§ã‚ã‚Œã°ã€ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ã¨ãªã‚Šã¾ã™ã€‚

ã‚ˆã£ã¦ã€ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ã‚’æ„è­˜ã™ã¹ãçŠ¶æ³ã¨ã¯ã€è¤‡æ•°ã‚¹ãƒ¬ãƒƒãƒ‰ã§å…±æœ‰ã•ã‚Œã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå­˜åœ¨ã—ã€ãã‚ŒãŒãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ã§ã‚ã‚‹å ´åˆã¨ãªã‚Šã¾ã™ã€‚

# ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ã§ãªã„ã¨ä½•ãŒå›°ã‚‹ã®ã‹

## Race Condition ï¼ˆç«¶åˆçŠ¶æ…‹ï¼‰

Race Condition ã«ã‚ˆã‚Šã€äºˆæœŸã—ãªã„çŠ¶æ…‹ãŒå¼•ãèµ·ã“ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
ãã‚Œã¯ã€ãƒã‚°ã‚„ãƒ‡ãƒ¼ã‚¿ä¸æ•´åˆã«ç¹‹ãŒã‚Šã¾ã™ã—ã€ç™ºè¦‹ã•ã‚Œã‚Œã°æ—©æ€¥ã«è§£æ±ºã™ã¹ãå•é¡Œã¨ãªã‚Šãˆã¾ã™ã€‚

> è¤‡æ•°ã®å‡¦ç†ãŒåŒæ™‚ã«è¡Œã‚ã‚ŒãŸéš›ã«ç«¶åˆçŠ¶æ…‹ã«ã‚ˆã£ã¦äºˆæœŸã—ãªã„çŠ¶æ…‹ãŒå¼•ãèµ·ã“ã•ã‚Œã‚‹å•é¡Œ
> ï¼ˆå‚è€ƒï¼š[ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ï¼ˆRace Conditionï¼‰ã¨ã¯ï¼Ÿ](https://www.securify.jp/blog/race-condition/)ï¼‰

:::message
"å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"ã¨æ–­è¨€ã‚’é¿ã‘ãŸã®ã¯ã€Race Condition ãŒç™ºç”Ÿã—ãªã„ã“ã¨ãŒã‚ã‚‹ã‹ã‚‰ã§ã™ã€‚
ç™ºç”Ÿã™ã‚‹ã‹å¦ã‹ã¯ã€è¤‡æ•°ã‚¹ãƒ¬ãƒƒãƒ‰ãŒå‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãªã©ã«ä¾å­˜ã—ã€éæ±ºå®šçš„ã¨ãªã‚Šã¾ã™ã€‚
:::

ä¾‹ãˆã°ã€ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦ã¿ã¾ã™ã€‚

```java
@NotThreadSafe
public class LazyInitRace {
    private ExpensiveObject instance = null;

    public ExpensiveObject getInstance() {
        if (instance == null) {
            instance = new ExpensiveObject();
        }
        return instance;
    }
}
```

ä¸Šè¨˜ã®ä¾‹ã§ã¯ã€`instance` å¤‰æ•°ã¯ 1 åº¦ã ã‘ç”Ÿæˆã•ã‚Œã€ãã®å¾Œã®å‘¼ã³å‡ºã—ã§ã¯åŒã˜ã‚‚ã®ãŒä½¿ã‚ã‚Œã‚‹ã¨æƒ³å®šã•ã‚Œã¦ã„ã¾ã™ã€‚

ã—ã‹ã—ã€ä¾‹ãˆã°ã€2 ã¤ã®ã‚¹ãƒ¬ãƒƒãƒ‰ãŒåŒæ™‚ã« `getInstance` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ãŸå ´åˆã€ãã‚Œãã‚ŒãŒåŒæ™‚ã« `instance == null` ã¨åˆ¤æ–­ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

ãã®å ´åˆã€ãã‚Œãã‚Œã®ã‚¹ãƒ¬ãƒƒãƒ‰ã®å‘¼å‡ºã«åŸºã¥ã„ã¦è¤‡æ•°ã® `ExpensiveObject` ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ç”ŸæˆãŒé–‹å§‹ã•ã‚Œã€`getInstance` ãƒ¡ã‚½ãƒƒãƒ‰ã‹ã‚‰è¿”å´ã•ã‚Œã‚‹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ãã‚Œãã‚Œç•°ãªã‚‹ã‚‚ã®ã¨ãªã‚Šã¾ã™ã€‚

ã“ã‚Œã¯ `LazyInitRace` ã‚¯ãƒ©ã‚¹ãŒæƒ³å®šã—ã¦ã„ã‚‹ä½¿ã‚ã‚Œæ–¹ã¨ã¯ç•°ãªã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

# ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ã®å®Ÿç¾æ–¹å¼ä¾‹

## Immutabilityï¼ˆä¸å¤‰æ€§ï¼‰

è¤‡æ•°ã‚¹ãƒ¬ãƒƒãƒ‰ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã‚‹å€¤ã‚’ä¸å¤‰ã«ã—ã¦ã—ã¾ãˆã°ã€ãã‚Œã¯ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ã¨ãªã‚Šã¾ã™ã€‚
è¤‡æ•°ã‚¹ãƒ¬ãƒƒãƒ‰ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã‚‹ã“ã¨ã«ã‚ˆã‚Šã€ãƒ‡ãƒ¼ã‚¿ä¸æ•´åˆã®ç™ºç”Ÿã‚’å¿ƒé…ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

```java
public class AccountId {
    // final ä¿®é£¾å­ã«ã‚ˆã‚Šã€å€¤ã®å†ä»£å…¥ä¸å¯ï¼ˆã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ï¼‰
    private final String id;

    public AccountId(String id) {
        this.id = id;
    }

    // è¿”å´ã™ã‚‹ id å¤‰æ•°ã¯ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ãªã®ã§ã€
    // è¤‡æ•°ã‚¹ãƒ¬ãƒƒãƒ‰ã‹ã‚‰åŒæ™‚ã«å‘¼å‡ºã•ã‚Œã¦ã‚‚ä¸æ•´åˆãªçµæœã¯è¿”ã•ãªã„
    public String id() {
        return id;
    }
}
```

## Thread Confinement (é–‰ã˜è¾¼ã‚)

å„ã‚¹ãƒ¬ãƒƒãƒ‰ã«ã‚¹ã‚³ãƒ¼ãƒ—ã‚’é™å®šã—ã¦å¤‰æ•°ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚
ä¾‹ãˆã°ã€Java ã§ã¯ ThreadLocal ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§å®Ÿç¾ã§ãã¾ã™ã€‚

:::details ThreadLocal ã®ä»•çµ„ã¿

- ThreadLocal ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€å„ã‚¹ãƒ¬ãƒƒãƒ‰ã¯è‡ªåˆ†å°‚ç”¨ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚³ãƒ”ãƒ¼ã‚’æŒã¡ã¾ã™
- ä»–ã‚¹ãƒ¬ãƒƒãƒ‰ãŒåŒã˜ ThreadLocal ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¸ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã‚‚ã€ç•°ãªã‚‹å€¤ãŒä¿å­˜/å‚ç…§ã•ã‚Œã¾ã™
- ãƒ‡ãƒ¼ã‚¿å…±æœ‰ã‚’é˜²ãã“ã¨ãŒã§ãã‚‹ãŸã‚ã€ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ãªå®Ÿè£…ã¨ãªã‚Šã¾ã™
  :::

```java
public class ThreadLocalExample {
    private static final ThreadLocal<Integer> threadLocalValue = ThreadLocal.withInitial(() -> 0);

    public int getValue() {
        return threadLocalValue.get();
    }

    public void setValue(int value) {
        threadLocalValue.set(value);
    }

    public static void main(String[] args) {
        final ThreadLocalExample example = new ThreadLocalExample();

        // ã‚¹ãƒ¬ãƒƒãƒ‰A
        final Thread threadA = new Thread(() -> {
            example.setValue(10);
            System.out.println("Thread A Value: " + example.getValue());
        });

        // ã‚¹ãƒ¬ãƒƒãƒ‰B
        final Thread threadB = new Thread(() -> {
            example.setValue(20);
            System.out.println("Thread B Value: " + example.getValue());
        });

        // ThreadLocal ã‚’ä½¿ã£ã¦ã„ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€ã‚¹ãƒ¬ãƒƒãƒ‰é–“ã§å€¤ãŒå…±æœ‰ã•ã‚Œãªã„ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ç«¶åˆï¼ˆRace Conditionï¼‰ãŒç™ºç”Ÿã—ãªã„
        threadA.start();
        threadB.start();
    }
}
```

## Delegationï¼ˆã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•æ€§ã®ç§»è­²ï¼‰

ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•æ€§ã®ç§»è­²ã¨ã„ã†è¡¨ç¾ã ã‘ã§ã¯ã€æ¦‚å¿µã‚’ç†è§£ã—ãã‚Œãªã„ã®ã§ã€ä¾‹ã‚’ç”¨ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€ä»¥ä¸‹ã®ã‚¯ãƒ©ã‚¹ãŒã‚ã‚Šã¾ã™ã€‚
å¤‰æ•°`x` `y` ã¯ `final`ä¿®é£¾å­ãŒä»˜ã‘ã‚‰ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ã«ãªã‚Šã¾ã™ã€‚
ã¤ã¾ã‚Šã€`Point`ã‚¯ãƒ©ã‚¹ã¯ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ã«ãªã‚Šã¾ã™ã€‚

```java
@ThreadSafe
public class Point {
    public final int x, y;

    public Point(int x, int y) {
        this.x = x;
        this.y = y;
    }
}
```

æ¬¡ã«ã€å…ˆã»ã©ã®`Point`ã‚¯ãƒ©ã‚¹ã‚’åˆ©ç”¨ã—ãŸä¾‹ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
ä»¥ä¸‹ã§ç¤ºã—ã¦ã„ã‚‹`DelegatingVehicleTracker`ã‚¯ãƒ©ã‚¹ã¯ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ã«ãªã‚Šã¾ã™ã€‚
å®Ÿã¯`DelegatingVehicleTracker`ã‚¯ãƒ©ã‚¹ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•æ€§ã¯`Point`ã‚¯ãƒ©ã‚¹ã«ä¾å­˜ã—ã¦ã„ã¾ã™ã€‚
`Point`ã‚¯ãƒ©ã‚¹ãŒã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ã§ãªã‘ã‚Œã°ã€`DelegatingVehicleTracker`ã‚¯ãƒ©ã‚¹ã¯ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ã«ãªã‚Šã¾ã›ã‚“ã€‚

```java
@ThreadSafe
public class DelegatingVehicleTracker {
    private final ConcurrentMap<String, Point> locations;
    private final Map<String, Point> unmodifiableMap;

    public DelegatingVehicleTracker(Map<String, Point> points) {
        locations = new ConcurrentHashMap<>(points);
        unmodifiableMap = Collections.unmodifiableMap(locations);
    }

    public Map<String, Point> getLocations() {
        return unmodifiableMap;
    }

    public Point getLocation(String id) {
        return locations.get(id);
    }

    public void setLocations(String id, int x, int y) {
        if (locations.replace(id, new Point(x, y)) == null) {
            throw new IllegalArgumentException("invalid vehicle name: " + id);
        }
    }
}
```

å…ˆã»ã©`Point`ã‚¯ãƒ©ã‚¹ã‚’ç¤ºã—ã¾ã—ãŸãŒã€åŒã˜æ©Ÿèƒ½ã‚’æä¾›ã—ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ãªã‚¯ãƒ©ã‚¹ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ä»¥ä¸‹ã«`MutablePoint`ã‚¯ãƒ©ã‚¹ã‚’ç¤ºã—ã¾ã™ã€‚ã“ã‚Œã¯ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
ãªãœãªã‚‰è¤‡æ•°ã‚¹ãƒ¬ãƒƒãƒ‰ãŒåŒæ™‚ã«`MutablePoint`ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¸ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸå ´åˆã€
ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ã§ã‚ã‚‹å¤‰æ•°`x` `y`ãŒæ›´æ–°ã•ã‚Œã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ãŒã€
æ‚ªã„ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ãã‚ŒãŒé‡ãªã‚‹ã¨`x` `y`ã¯æ„å›³ã—ãªã„å€¤ã¨ãªã‚‹ã“ã¨ãŒã‚ã‚‹ã‹ã‚‰ã§ã™ã€‚

```java
@NotThreadSafe
public class MutablePoint {
    public int x, y;

    public MutablePoint() { x = 0; y = 0; }
    public MutablePoint(MutablePoint p) {
        this.x = p.x;
        this.y = p.y;
    }
}
```

å…ˆã»ã©è¿°ã¹ãŸã‚ˆã†ã«ã€`DelegatingVehicleTracker`ã‚¯ãƒ©ã‚¹ã¯ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ã«ãªã‚Šã¾ã™ãŒã€`Point`ã‚¯ãƒ©ã‚¹ã®ä»£ã‚ã‚Šã«`MutablePoint`ã‚¯ãƒ©ã‚¹ã‚’ä½¿ã†ã¨ã€ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ã§ã¯ãªããªã‚Šã¾ã™ã€‚

ãªãœãªã‚‰`getLocations`ãƒ¡ã‚½ãƒƒãƒ‰ã§å–å¾—ã—ãŸ`Map`ã‚’çµŒç”±ã—ã¦ã€`Point`ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å–å¾—ã—æ“ä½œã§ãã‚‹ã‹ã‚‰ã§ã™ã€‚
`Point`ã‚¯ãƒ©ã‚¹ãŒã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ã§ãªã„ã¨ã€è¤‡æ•°ã‚¹ãƒ¬ãƒƒãƒ‰ã‹ã‚‰åŒæ™‚ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚ŒãŸå ´åˆã«ä¸æ•´åˆãŒç”Ÿã˜ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Š`DelegatingVehicleTracker`ã‚¯ãƒ©ã‚¹ã‚‚ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ã§ã¯ãªããªã£ã¦ã—ã¾ã„ã¾ã™ã€‚

ã“ã‚Œã¯ã¤ã¾ã‚Š`DelegatingVehicleTracker`ã‚¯ãƒ©ã‚¹ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•æ€§ãŒ`Point`ã‚¯ãƒ©ã‚¹ã«ç§»è­²ã•ã‚Œã¦ã„ã‚‹ã¨ã„ã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

ã“ã®æ¦‚å¿µã‚’å¿œç”¨ã™ã‚‹ã¨ã€ä¾‹ãˆã°è‡ªä½œã‚¯ãƒ©ã‚¹ã‚’ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ã«ã—ãŸã‘ã‚Œã°ã€æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãªã©ãŒæä¾›ã—ã¦ã„ã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ãªã‚¯ãƒ©ã‚¹ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€ç°¡å˜ã«ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ãªå®Ÿè£…ã¨ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã¨ãªã‚Šã¾ã™ã€‚

## Producer Consumer Pattern

Producer Consumer Pattern ã¨ã¯ã€ã‚­ãƒ¥ãƒ¼ã®ã‚ˆã†ãª FIFO ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’åˆ©ç”¨ã—ã¦ã€å‡¦ç†å¯¾è±¡ã‚’æ¸¡ã™ Producer å´ã¨ã€å‡¦ç†å¯¾è±¡ã‚’å–å¾—ã—ã¦é©åˆ‡ãªå‡¦ç†ã‚’è¡Œã† Consumer å´ã¨ã«åˆ†ã‘ã¦å®Ÿè£…ã™ã‚‹æ–¹å¼ã§ã™ã€‚

:::details Synchronizer
ã‚¹ãƒ¬ãƒƒãƒ‰ã®åˆ¶å¾¡ãƒ•ãƒ­ãƒ¼ã‚’ã€çŠ¶æ…‹ã«åŸºã¥ã„ã¦èª¿æ•´ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ Synchronizer ã¨ã„ã†ã€‚
Synchronizer ã¨ã—ã¦æ©Ÿèƒ½ã™ã‚‹ã‚‚ã®ã¨ã—ã¦ã€ä¾‹ãˆã°ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚‚ã®ãŒã‚ã‚‹ã€‚

- Blocking Queue
- Semaphores (ä¿¡å·è£…ç½®ã€ã‚·ã‚°ãƒŠãƒ«)
- Barriers
- Latchesï¼ˆãƒ‰ã‚¢ãƒ»é–€ãªã©ã®æ›ã‘é‡‘ï¼‰

:::

ä»¥ä¸‹ã«ã€Producer Consumer Pattern ã‚’åˆ©ç”¨ã—ãŸå®Ÿè£…ä¾‹ã‚’ç¤ºã—ã¾ã™ã€‚

```java
// Producer ã¨ã—ã¦ã®å½¹å‰²ã‚’æœãŸã™
public class FileCrawler implements Runnable {
    private final BlockingQueue<File> fileQueue;
    private final FileFilter fileFilter;
    private final File root;
    ...
    public void run() {
        try {
            crawl(root);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }

    private void crawl(File root) throws InterruptedException {
        List<File> entries = root.listFiles(fileFilter);
        if (entries.isEmpty()) {
            return;
        }
        for (File entry : entries) {
            if (entry.isDirectory()) {
                crawl(entry);
            } else if (!alreadyIndexed(entry)) {
                fileQueue.put(entry);
            }
        }
    }
}

// Consumer ã¨ã—ã¦ã®å½¹å‰²ã‚’æœãŸã™
public class Indexer implements Runnable {
    private final BlockingQueue<File> queue;

    public Indexer(BlockingQueue<File> queue) {
        this.queue = queue;
    }

    public void run() {
        try {
            while (true) {
                indexFile(queue.take());
            }
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
}

// Producer Consumer ã®åˆ©ç”¨
public static void startIndexing(List<File> roots) {
    BlockingQueue<File> queue = new LinkedBlockingQueue<File>(BOUND);   // BOUND ã¯ã‚­ãƒ¥ãƒ¼ã®å®¹é‡
    FileFilter filter = new FileFilter() {
        public boolean accept(File file) { return true; }
    };

    for (File root : roots) {
        new Thread(new FileCrawler(queue, filter, root)).start();
    }
    for (int i = 0; i < N_CONSUMERS; i++) {
        new Thread(new Indexer(queue)).start();
    }
}
```

ä¸Šè¨˜ã®ä¾‹ã®ç€ç›®ç‚¹ã¯ã€ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚

- `FileCrawler` (Producer) ãŠã‚ˆã³ `Indexer` (Consumer) ã¨ã‚‚ã«ã€`queue` ã‚’ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§å—ã‘å–ã£ã¦ã„ã‚‹ã€‚ Producer ã¨ Consumer ã¯ç›´æ¥å‘¼å‡ºã‚’è¡Œã†é–¢ä¿‚ã§ã¯ãªã„ã€‚
- ä¸Šè¨˜ã®ä¾‹ãŒã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ã§ã‚ã‚‹ã‹ã¯ã€`queue` ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•æ€§ã«ä¾å­˜ã—ã¦ã„ã‚‹ã€‚

ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã¯ã€ç‰‡æ–¹ãŒ I/O-bound ã§ã€ã‚‚ã†ç‰‡æ–¹ãŒ CPU-bound ã§ã‚ã‚‹å ´åˆã«ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆãŒå‘ä¸Šã™ã‚‹ç­‰ã®ãƒ¡ãƒªãƒƒãƒˆã‚‚ã‚ã‚Šã¾ã™ã€‚

:::details ã€‡ã€‡-bound
"bound" ã¯ã€Œåˆ¶ç´„ã•ã‚Œã¦ã„ã‚‹ã€ã€Œé™ç•Œã«é”ã—ã¦ã„ã‚‹ã€ã¨ã„ã†æ„å‘³ã§ã€ã‚·ã‚¹ãƒ†ãƒ ã®ã©ã®éƒ¨åˆ†ãŒãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã«ãªã£ã¦ã„ã‚‹ã‹ã‚’è¡¨ã™ã€‚
I/O-bound ã¯ã€å…¥å‡ºåŠ›å‡¦ç†ï¼ˆI/Oï¼‰ãŒãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã«ãªã£ã¦ã„ã‚‹çŠ¶æ…‹ã€‚
:::

# ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ã§æ°—ã‚’ä»˜ã‘ã‚‹ã“ã¨

## ä¸å¤‰æ¡ä»¶ï¼ˆInvariantï¼‰

ã¾ãšã€ä¸å¤‰æ¡ä»¶(invariant) ã¨ã¯ã€ã‚ã‚‹å‡¦ç†ãŒè¡Œã‚ã‚Œã‚‹å‰å¾Œã§å¸¸ã«ä¿æŒã•ã‚Œã‚‹ã¹ãçŠ¶æ…‹ã¾ãŸã¯æ¡ä»¶ã®ã“ã¨ã‚’è¨€ã„ã¾ã™ã€‚

ä¾‹ãˆã°ã€è¤‡æ•°ã®ãƒ¡ãƒ³ãƒå¤‰æ•°ãŒãŠäº’ã„ã®é–¢ä¿‚æ€§ã«åˆ¶ç´„æ¡ä»¶ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã€å„ã€…ã‚’ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ã«ã™ã‚‹ã ã‘ã§ã¯ä¸ååˆ†ã§ã™ã€‚
ãã®è¤‡æ•°ã®ãƒ¡ãƒ³ãƒå¤‰æ•°ã‚’ä½µã›ã¦ãƒ­ãƒƒã‚¯ã—ã€ä¸æ•´åˆãªé–¢ä¿‚æ€§ã«ãªã‚‰ãšåˆ¶ç´„æ¡ä»¶ã‚’å®ˆã‚‹ã“ã¨ã‚’ä¿è¨¼ã—ãªã‘ã‚Œã°ã„ã‘ã¾ã›ã‚“ã€‚

ã“ã¡ã‚‰ã‚‚ä¾‹ã‚’äº¤ãˆã¦èª¬æ˜ã—ã¾ã™ã€‚
ä»¥ä¸‹ã«ç¤ºã™`NumberRange`ã‚¯ãƒ©ã‚¹ã¯ 2 ã¤ã®ãƒ¡ãƒ³ãƒå¤‰æ•°`lower` `upper`ã‚’æŒã£ã¦ã„ã¾ã™ã€‚

```java
public class NumberRange {
    // INVARIANT: lower <= upper
    private final AtomicInteger lower = new AtomicInteger(0);
    private final AtomicInteger upper = new AtomicInteger(0);

    public void setLower(int i) {
        // Warning -- unsafe check-then-act
        if (i > upper.get()) {
            throw new IllegalArgumentException("can't set lower to " + i + " > upper");
        }
        lower.set(i);
    }

    public void setUpper(int i) {
        // Warning -- unsafe check-then-act
        if (i < lower.get()) {
            throw new IllegalArgumentException("can't set upper to " + i + " < lower");
        }
        upper.set(i);
    }

    public boolean isInRange(int i) {
        return i >= lower.get() && i <= upper.get();
    }
}
```

`lower`ã¨`upper`ã¯ã€ãã‚Œãã‚Œ`AtomicInteger`å‹ã¨ã—ã¦å®šç¾©ã•ã‚Œã¦ã„ã¦ã€è¤‡æ•°ã‚¹ãƒ¬ãƒƒãƒ‰ã‹ã‚‰åŒæ™‚ã«ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã¦ã‚‚ã€ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚ŒãŸé †åºã«åŸºã¥ã„ã¦å€¤ã‚’æ›´æ–°ã—ã¦ã„ãã“ã¨ãŒå¯èƒ½ã§ã™ã€‚
ã—ã‹ã—ã€ä¸å¤‰æ¡ä»¶ã§ã‚ã‚‹ `lower` < `upper` ãŒæº€ãŸã•ã‚Œãªããªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

ä¾‹ãˆã°ã€`NumberRange`ãŒ (0,10) ã§ã‚ã‚‹ã¨ã—ã¦ã€
ã‚¹ãƒ¬ãƒƒãƒ‰ Aï¼š`setLower(5)` ã‚’å‘¼å‡º
ã‚¹ãƒ¬ãƒƒãƒ‰ Bï¼š`setUpper(4)` ã‚’å‘¼å‡º
ã‚’åŒæ™‚ã«è¡Œã£ãŸã¨ã—ã¾ã™ã€‚

ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒæ‚ªã„ã¨ä¸¡æ–¹ã®å‘¼å‡ºã§ if æ–‡ã«ã‚ˆã‚‹ãƒã‚§ãƒƒã‚¯ã«å¼•ã£ã‹ã‹ã‚‰ãšã€ãã‚Œãã‚ŒãŒæ›´æ–°ã•ã‚Œã¾ã™ã€‚ãã®çµæœã€`NumberRange`ãŒ (5,4) ã¨ãªã£ã¦ã—ã¾ã„ã€ä¸å¤‰æ¡ä»¶ã«åã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

ã“ã®ã‚ˆã†ã«è¤‡æ•°ã®å¤‰æ•°ãŒçµ„ã¿åˆã‚ã•ã£ã¦ä¸å¤‰æ¡ä»¶ãŒæ§‹æˆã•ã‚Œã¦ã„ã‚‹å ´åˆã¯æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚
ãã‚Œãã‚Œã®å¤‰æ•°ã‚’æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒæä¾›ã—ã¦ã„ã‚‹ã‚ˆã†ãªã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ãªå‹ã§å®šç¾©ã—ã¦ã‚‚ä¸å¤‰æ¡ä»¶ãŒæº€ãŸã•ã‚Œã¾ã›ã‚“ã€‚

ä»Šå›ã®å ´åˆã€ä¸Šè¨˜ã®ã‚ˆã†ãªä¸å¤‰æ¡ä»¶ã‚’å®ˆã‚‹ãŸã‚ã«ã¯ã€`setUpper`ãƒ¡ã‚½ãƒƒãƒ‰ã€`setLower`ãƒ¡ã‚½ãƒƒãƒ‰ã§å…±é€šãƒ­ãƒƒã‚¯ã‚’ç”¨ã„ã‚‹ã“ã¨ãŒè§£æ±ºç­–ã® 1 ã¤ã«ãªã‚Šã¾ã™ã€‚

## ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã‚€ãƒ»è¨˜è¼‰ã™ã‚‹

ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚„ä»–é–‹ç™ºè€…ãŒå®Ÿè£…ã—ãŸãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æ‰±ã†å ´åˆã¯ã€å¿…ãšãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèªã—ã€ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ãªå®Ÿè£…ã‚’è¡Œã†ä¸Šã§ã®æ³¨æ„ç‚¹ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ãªã„ã‹è¦‹ã¾ã—ã‚‡ã†ã€‚

ã¾ãŸã€è‡ªåˆ†ãŒãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å®Ÿè£…ã™ã‚‹éš›ã«ã‚‚ã€æ³¨æ„ç‚¹ã‚’å¿…ãšãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¨˜è¼‰ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚ä»–ã®é–‹ç™ºè€…ã«ã¨ã£ã¦ã‚‚å¤§ããªåŠ©ã‘ã«ãªã‚Šã¾ã™ã—ã€å°†æ¥ã®è‡ªåˆ†ã«ã¨ã£ã¦ã‚‚å‚™å¿˜éŒ²ã¨ã—ã¦æ®‹ã—ã¦ãŠãã“ã¨ã¯ä¾¡å€¤ãŒã‚ã‚Šã¾ã™ã€‚

# ãŠã‚ã‚Šã«

ä»Šå›ã¯ã€ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ã®æ¦‚å¿µã‚„å®Ÿç¾æ–¹å¼ã®ä¾‹ãªã©ã‚’èª¬æ˜ã—ã¾ã—ãŸã€‚
å®Ÿç¾æ–¹å¼ã‚„æ°—ã‚’ä»˜ã‘ã‚‹ã¹ãç‚¹ã«ã¤ã„ã¦ã¯ã€ä»–ã«ã‚‚æ§˜ã€…ã‚ã‚Šã¾ã™ãŒã€ä»Šå›ã¯åŸºç¤çš„ãªå†…å®¹ã«ç•™ã‚ã¦ã„ã¾ã™ã€‚

å®Ÿéš›ã«ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ãªå®Ÿè£…ã‚’è¡Œã†å ´åˆã€ä¸»ã«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®åˆ©ç”¨ã‚’æ¤œè¨ã™ã‚‹ã“ã¨ã«ãªã‚‹ã¨æ€ã„ã¾ã™ãŒã€å‡¦ç†ãŒ CPU-bound ã¾ãŸã¯ I/O-bound ã«ã‚ˆã£ã¦åˆ©ç”¨ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒå¤‰ã‚ã£ã¦ããŸã‚Šã—ã¾ã™ã€‚
ã¾ãŸã€éåº¦ã«ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ã‚’æ„è­˜ã—ã¦ãƒ­ãƒƒã‚¯ã‚’å–å¾—ã™ã‚‹ç¯„å›²ã‚’åºƒãå–ã‚‹ã¨ã€æ¬¡ã¯ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡ŒãŒç™ºç”Ÿã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

ä¸Šè¨˜ã®å†…å®¹ã«ã¤ã„ã¦ã¯ã€ã¾ãŸæ©Ÿä¼šãŒã‚ã‚Œã°è¨˜äº‹ã‚’æ›¸ããŸã„ã¨æ€ã„ã¾ã™ã€‚

ãã‚Œã§ã¯ï¼
